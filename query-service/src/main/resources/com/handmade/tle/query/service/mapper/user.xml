<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="user">

    <resultMap id="userResult" type="map">
        <result property="id" column="id"/>
        <result property="email" column="email"/>
        <result property="googleSub" column="google_sub"/>
        <result property="fullName" column="full_name"/>
        <result property="username" column="username"/>
        <result property="bio" column="bio"/>
        <result property="pictureUrl" column="picture_url"/>
        <result property="emailVerified" column="email_verified"/>
        <result property="status" column="status"/>
        <result property="isActive" column="is_active"/>
        <result property="lastLogin" column="last_login"/>
        <result property="createdAt" column="created_at"/>
        <result property="version" column="version"/>
    </resultMap>

    <resultMap id="googleAccountResult" type="map">
        <result property="id" column="id"/>
        <result property="googleUserId" column="google_user_id"/>
        <result property="userId" column="user_id"/>
        <result property="email" column="email"/>
        <result property="displayName" column="display_name"/>
        <result property="picture" column="picture"/>
        <result property="connectedAt" column="connected_at"/>
        <result property="disconnectedAt" column="disconnected_at"/>
    </resultMap>

    <resultMap id="sessionResult" type="map">
        <result property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="ipAddress" column="ip_address"/>
        <result property="userAgent" column="user_agent"/>
        <result property="deviceType" column="device_type"/>
        <result property="location" column="location"/>
        <result property="isActive" column="is_active"/>
        <result property="createdAt" column="created_at"/>
        <result property="lastActivityAt" column="last_activity_at"/>
        <result property="expiresAt" column="expires_at"/>
    </resultMap>

    <!-- User Queries -->
    <select id="searchUsers-count" resultType="int">
        SELECT COUNT(*) FROM users
        <where>
            <if test="email != null">
                AND email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="username != null">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="fullName != null">
                AND full_name LIKE CONCAT('%', #{fullName}, '%')
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="isActive != null">
                AND is_active = #{isActive}
            </if>
        </where>
    </select>

    <select id="searchUsers" resultMap="userResult">
        SELECT * FROM users
        <where>
            <if test="email != null">
                AND email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="username != null">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="fullName != null">
                AND full_name LIKE CONCAT('%', #{fullName}, '%')
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="isActive != null">
                AND is_active = #{isActive}
            </if>
        </where>
        ${orderby} ${pagination}
    </select>

    <select id="getUserById" resultMap="userResult">
        SELECT * FROM users WHERE id = #{id}
    </select>

    <select id="getUserByEmail" resultMap="userResult">
        SELECT * FROM users WHERE email = #{email}
    </select>

    <!-- Google Account Queries -->
    <select id="getUserGoogleAccounts-count" resultType="int">
        SELECT COUNT(*) FROM google_accounts WHERE user_id = #{userId}
    </select>

    <select id="getUserGoogleAccounts" resultMap="googleAccountResult">
        SELECT * FROM google_accounts 
        WHERE user_id = #{userId}
        AND disconnected_at IS NULL
        ${orderby} ${pagination}
    </select>

    <!-- Session Queries -->
    <select id="getUserSessions-count" resultType="int">
        SELECT COUNT(*) FROM sessions 
        WHERE user_id = #{userId}
        <if test="isActive != null">
            AND is_active = #{isActive}
        </if>
    </select>

    <select id="getUserSessions" resultMap="sessionResult">
        SELECT * FROM sessions 
        WHERE user_id = #{userId}
        <if test="isActive != null">
            AND is_active = #{isActive}
        </if>
        ${orderby} ${pagination}
    </select>

</mapper>
